---
import inovera from "../../assets/inovera.png";
import mediamag from "../../assets/mediamag.png";

import adonisLogo from "../../assets/technos/adonis.svg";
import cplusplusLogo from "../../assets/technos/cplusplus.svg";
import mysqlLogo from "../../assets/technos/mysql.svg";
import phpLogo from "../../assets/technos/php.svg";
import pythonLogo from "../../assets/technos/python.svg";
import reactLogo from "../../assets/technos/react.svg";
import symfonyLogo from "../../assets/technos/symfony.svg";
import typescriptLogo from "../../assets/technos/typescript.svg";
import TechTag from "../TechTag.astro";
import type { Language } from "../../i18n/config";

interface Props {
  lang: Language;
  translations: any;
}

const { lang, translations } = Astro.props;
const t = translations.work;

const workExperiences = [
  {
    company: {
      name: "MÃ©diamag",
      logo: mediamag,
      website: "https://www.mediamag-systeme.com/",
    },
    position: t.companies.mediamag.position,
    dateRange: t.companies.mediamag.dateRange,
    tasks: t.companies.mediamag.tasks,
    technologies: [
      { name: "AdonisJS", logo: adonisLogo, url: "https://adonisjs.com/" },
      { name: "C++", logo: cplusplusLogo, url: "https://cplusplus.com/" },
      { name: "MySQL", logo: mysqlLogo, url: "https://www.mysql.com/" },
      { name: "Python", logo: pythonLogo, url: "https://www.python.org/" },
      { name: "React", logo: reactLogo, url: "https://react.dev/" },
      {
        name: "TypeScript",
        logo: typescriptLogo,
        url: "https://www.typescriptlang.org/",
      },
    ],
  },
  {
    company: {
      name: "Inovera",
      logo: inovera,
      website: "https://www.inovera.fr/",
    },
    position: t.companies.inovera.position,
    dateRange: t.companies.inovera.dateRange,
    isCurrentJob: true,
    tasks: t.companies.inovera.tasks,
    technologies: [
      { name: "MySQL", logo: mysqlLogo, url: "https://www.mysql.com/" },
      { name: "PHP", logo: phpLogo, url: "https://www.php.net/" },
      { name: "React", logo: reactLogo, url: "https://react.dev/" },
      { name: "Symfony", logo: symfonyLogo, url: "https://symfony.com/" },
      {
        name: "TypeScript",
        logo: typescriptLogo,
        url: "https://www.typescriptlang.org/",
      },
    ],
  },
];
---

<section id="work">
  <div class="work__wrapper">
    <h2 class="work__title" data-reveal="up">
      <span>{t.title}</span>
    </h2>

    <div class="work__layout">
      <!-- Tab Content -->
      <div class="work__content" data-reveal="up" data-reveal-delay="1">
        {
          workExperiences.map((experience, index) => (
            <article
              class={`work__panel ${index === 0 ? "work__panel--active" : ""}`}
              data-panel-index={index}
              role="tabpanel"
              id={`panel-${index}`}
              aria-labelledby={`tab-${index}`}
            >
              <header class="work__panel-header">
                <div class="work__panel-title">
                  <img
                    src={experience.company.logo.src}
                    alt={experience.company.name}
                    class="work__panel-logo"
                  />
                  <div class="work__panel-info">
                    <h3>
                      {experience.position}{" "}
                      <span>@ {experience.company.name}</span>
                    </h3>
                    <span class="work__panel-date">
                      {experience.dateRange}
                      {experience.isCurrentJob && (
                        <span class="work__panel-badge" />
                      )}
                    </span>
                  </div>
                  <a
                    href={experience.company.website}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="work__panel-cta"
                    draggable="false"
                  >
                    {t.companySite}
                  </a>
                </div>
              </header>

              <ul class="work__panel-tasks">
                {experience.tasks.map((task) => (
                  <li>{task}</li>
                ))}
              </ul>

              <footer class="work__panel-footer">
                <h4>{t.technologies}</h4>
                <div class="work__panel-techs">
                  {experience.technologies.map((tech) => (
                    <TechTag
                      name={tech.name}
                      logo={tech.logo}
                      url={tech.url}
                      className="work__panel-tech"
                    />
                  ))}
                </div>
              </footer>
            </article>
          ))
        }
      </div>

      <!-- Tabs Navigation -->
      <div class="work__tabs" data-reveal="up" data-reveal-delay="2">
        {
          workExperiences.map((experience, index) => (
            <button
              class={`work__tab ${index === 0 ? "work__tab--active" : ""}`}
              data-tab-index={index}
              type="button"
              role="tab"
              aria-selected={index === 0 ? "true" : "false"}
              aria-controls={`panel-${index}`}
              id={`tab-${index}`}
              aria-label={experience.company.name}
            >
              {experience.isCurrentJob && (
                <span class="work__tab-pulse" aria-label="Poste actuel" />
              )}
              <img
                src={experience.company.logo.src}
                alt={experience.company.name}
                class="work__tab-logo"
              />
              <div class="work__tab-info">
                <span class="work__tab-position">{experience.position}</span>
                <span class="work__tab-date">{experience.dateRange}</span>
              </div>
            </button>
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  function initWorkTabs() {
    const tabs = document.querySelectorAll<HTMLButtonElement>(".work__tab");
    const panels = document.querySelectorAll<HTMLElement>(".work__panel");

    tabs.forEach((tab, index) => {
      tab.addEventListener("click", () => {
        // Remove active class from all tabs and panels
        tabs.forEach((t) => {
          t.classList.remove("work__tab--active");
          t.setAttribute("aria-selected", "false");
        });
        panels.forEach((p) => p.classList.remove("work__panel--active"));

        // Add active to clicked tab and corresponding panel
        tab.classList.add("work__tab--active");
        tab.setAttribute("aria-selected", "true");
        panels[index].classList.add("work__panel--active");
      });
    });

    // Keyboard navigation
    tabs.forEach((tab, index) => {
      tab.addEventListener("keydown", (e) => {
        let newIndex = index;

        if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
          e.preventDefault();
          newIndex = index > 0 ? index - 1 : tabs.length - 1;
        } else if (e.key === "ArrowRight" || e.key === "ArrowDown") {
          e.preventDefault();
          newIndex = index < tabs.length - 1 ? index + 1 : 0;
        }

        if (newIndex !== index) {
          tabs[newIndex].click();
          tabs[newIndex].focus();
        }
      });
    });
  }

  // Initialize on page load
  initWorkTabs();

  // Re-initialize on Astro navigation
  document.addEventListener("astro:page-load", initWorkTabs);
</script>
