---
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import navigationScript from "../navigation.js?url";
import { getPreferredLanguage, setLanguageCookie } from "../i18n/languageManager";
import { getTranslations } from "../i18n/utils";
import type { Language } from "../i18n/config";

// Detect language
const acceptLanguage = Astro.request.headers.get("accept-language");
const lang: Language = getPreferredLanguage(Astro.cookies, acceptLanguage);

// Set cookie for persistence
setLanguageCookie(Astro.cookies, lang);

// Load translations
const translations = await getTranslations(lang);

// Get pathname for canonical URL
const pathname = new URL(Astro.request.url).pathname;

// Props
interface Props {
  title?: string;
}

const { title = "Clément Maillet" } = Astro.props;
---

<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="color-scheme" content="light only" />
    <script
      defer
      src="https://analytics.maillet.bzh/script.js"
      data-website-id="bfa40e8c-c928-4462-8104-1ba45c1cdcae"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="generator" content={Astro.generator} />

    <meta name="geo.region" content="FR-56" />
    <meta name="geo.placename" content="Bretagne, France" />

    <meta
      name="description"
      content={translations.meta.description}
    />
    <meta name="author" content="Clément Maillet" />
    <meta name="robots" content="index, follow" />

    <meta
      property="og:title"
      content={translations.meta.ogTitle}
    />
    <meta
      property="og:description"
      content={translations.meta.ogDescription}
    />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://maillet.bzh/" />
    <meta property="og:image" content="https://maillet.bzh/Banner.png" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta
      name="twitter:title"
      content={translations.meta.ogTitle}
    />
    <meta
      name="twitter:description"
      content={translations.meta.ogDescription}
    />
    <meta name="twitter:image" content="https://maillet.bzh/Banner.png" />
    <title>{title}</title>
    <script
      type="text/javascript"
      src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"
      defer
      referrerpolicy="strict-origin-when-cross-origin"
    ></script>
    <meta
      name="keywords"
      content={translations.meta.keywords}
    />
    <meta name="language" content={lang} />

    <!-- Hreflang tags for SEO -->
    <link rel="alternate" hreflang="fr" href={`https://maillet.bzh${pathname}?lang=fr`} />
    <link rel="alternate" hreflang="en" href={`https://maillet.bzh${pathname}?lang=en`} />
    <link rel="alternate" hreflang="x-default" href={`https://maillet.bzh${pathname}`} />

    <script type="application/ld+json" set:html={JSON.stringify({
      "@context": "https://schema.org",
      "@type": "Person",
      "name": "Clément Maillet",
      "jobTitle": translations.meta.jobTitle,
      "description": translations.meta.jobDescription,
      "url": "https://maillet.bzh",
      "image": "https://maillet.bzh/Banner.png",
      "sameAs": [
        "https://www.linkedin.com/in/cl%C3%A9ment-maillet-632895255/",
        "https://github.com/Karbbone"
      ]
    })}></script>
    <script type="text/javascript"
      data-success-message={translations.contact.form.success}
      data-error-message={translations.contact.form.error}
      id="emailjs-config">
      document.addEventListener("DOMContentLoaded", function () {
        const config = document.getElementById("emailjs-config");
        const successMessage = config.getAttribute("data-success-message");
        const errorMessage = config.getAttribute("data-error-message");

        // Attendre que EmailJS soit chargé (defer)
        function initEmailJS() {
          if (typeof emailjs !== "undefined") {
            emailjs.init({ publicKey: "hMHpVGsPfIgHbQrdu" });
            setupContactForm();
          } else {
            setTimeout(initEmailJS, 50);
          }
        }

        function setupContactForm() {
          const form = document.getElementById("contact-form");
          if (!form) return;
          const submitBtn = form.querySelector(".contact__form-submit");

          form.addEventListener("submit", function (event) {
            event.preventDefault();
            if (!form.checkValidity()) {
              form.reportValidity();
              submitBtn.disabled = false;
              return;
            }
            submitBtn.disabled = true;
            emailjs.sendForm("service_r5nqngg", "template_0d1e8qq", this).then(
              function () {
                const successDiv = document.querySelector(".contact__success");
                successDiv.textContent = successMessage;
                successDiv.classList.add("contact__success--visible");
                if (window.grecaptcha) window.grecaptcha.reset();
                form.reset();
                submitBtn.disabled = false;
              },
              function () {
                const successDiv = document.querySelector(".contact__success");
                successDiv.textContent = errorMessage;
                successDiv.classList.add("contact__success--visible", "contact__success--error");
                submitBtn.disabled = false;
              }
            );
          });
        }

        initEmailJS();
      });
    </script>
    <script type="module" src={navigationScript}></script>
  </head>

  <body>
    <div id="wrapper">
      <Header lang={lang} translations={translations} />
      <main>
        <slot lang={lang} translations={translations} />
      </main>
    </div>

    <Footer lang={lang} translations={translations} />
    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
  </body>
</html>
